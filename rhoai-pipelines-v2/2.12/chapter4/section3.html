<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: RHOAI Data Science Pipelines</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">RHOAI Data Science Pipelines</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhoai-pipelines-v2" data-version="2.12">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">RHOAI Data Science Pipelines</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../LABENV/minio-install.html">MinIO S3 Compatible Storage Setup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter1/dsp-intro.html">Introduction to ML Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/dsp-concepts.html">Data Science Pipeline Concepts</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter2/index.html">Managing Data Science Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/data-science-pipeline-app.html">Data Science Pipeline Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/rhoai-resources.html">OpenShift AI Resources</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter3/index.html">Creating Pipelines with Elyra</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/elyra-pipelines.html">Elyra Pipelines</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">KFP SDK</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kfp-import.html">Kubeflow Pipelines SDK</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/appendix.html">Appendix - Lab Examples</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">RHOAI Data Science Pipelines</span>
    <span class="version">2.12</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">RHOAI Data Science Pipelines</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">2.12</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="paragraph">
<p>This is just reference info -tb updated</p>
</div>
<div class="sect2">
<h3 id="_data_science_pipelines"><a class="anchor" href="#_data_science_pipelines"></a>Data Science Pipelines</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">OpenShift AI Resource Name</th>
<th class="tableblock halign-left valign-top">Kubernetes Resource Name</th>
<th class="tableblock halign-left valign-top">Custom Resource</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Science Pipeline Application</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datasciencepipelinesapplications.datasciencepipelinesapplications.opendatahub.io</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSPA&#8217;s create an instance of Data Science Pipelines.  DSPA&#8217;s require a data connection and an S3 bucket to create the instance.  DSPA&#8217;s are namespace scoped to prevent leaking data across multiple projects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pipelines</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When developing a pipeline, depending on the tool, users may generate a YAML based PipelineRun object that is then uploaded into the Dashboard to create an executable pipeline.  Even though this yaml object is a valid Tekton PipelineRun it is intended to be uploaded to the Dashboard, and not applied directly to the cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pipeline Runs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pipelineruns.tekton.dev</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pipeline can be executed in a number of different ways, including from the Dashboard, which will result in the creation of a pipelinerun.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Create a local <strong>virtualenv</strong> on your workstation, install the <strong>kfp-tekton</strong> package</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ mkdir kfp #create a folder anywhere
$ cd kfp
$ python3 -m venv .venv
$ source .venv/bin/activate # activate the venv
$(.venv) pip install kfp-tekton~=1.5.0</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Using the correct Python module versions is critical to avoid conflicts between the KFP SDK and Data Science Pipelines versions. Install the latest <strong>kfp-tekton</strong> module version 1.5.x. Installing the 1.8.x versions will result in failures during pipeline runs.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_building_and_deploying_a_pipeline"><a class="anchor" href="#_building_and_deploying_a_pipeline"></a>Building and deploying a Pipeline</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the <a href="#attachment$coin-toss.py" class="xref unresolved">Coin Toss Pipeline</a> Python file and copy it to your <strong>kfp</strong> folder where you created the virtualenv. Inspect the file to understand how  the pipeline is composed using plain Python functions. The pipeline name and other metadata is provided using the <strong>@dsl.pipeline</strong> annotation. Note the invocation to the <strong>TektonCompiler</strong> in the <code>main</code> function:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">...
from kfp import dsl
from kfp import components
...

flip_coin_op = components.create_component_from_func(
    flip_coin, base_image='python:alpine3.6')
print_op = components.create_component_from_func(
    print_msg, base_image='python:alpine3.6')
random_num_op = components.create_component_from_func(
    random_num, base_image='python:alpine3.6')

@dsl.pipeline(
    name='conditional-execution-pipeline',
    description='Shows how to use dsl.Condition().'
)
def flipcoin_pipeline():
    flip = flip_coin_op()
    with dsl.Condition(flip.output == 'heads'):
        random_num_head = random_num_op(0, 9)
        with dsl.Condition(random_num_head.output &gt; 5):
            print_op('heads and %s &gt; 5!' % random_num_head.output)
        with dsl.Condition(random_num_head.output &lt;= 5):
            print_op('heads and %s &lt;= 5!' % random_num_head.output)

    with dsl.Condition(flip.output == 'tails'):
        random_num_tail = random_num_op(10, 19)
        with dsl.Condition(random_num_tail.output &gt; 15):
            print_op('tails and %s &gt; 15!' % random_num_tail.output)
        with dsl.Condition(random_num_tail.output &lt;= 15):
            print_op('tails and %s &lt;= 15!' % random_num_tail.output)


if __name__ == '__main__':
    from kfp_tekton.compiler import TektonCompiler
    TektonCompiler().compile(flipcoin_pipeline, __file__.replace('.py', '.yaml'))</code></pre>
</div>
</div>
</li>
<li>
<p>Compile the Python file into a Tekton resource definition. Run the following command from within the virtualenv.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">$(.venv) python3 coin-toss.py</code></pre>
</div>
</div>
</li>
<li>
<p>A YAML file called <code>coin-toss.yaml</code> containing a Tekton <strong><em>PipelineRun</em></strong> resource will be created. Inspect this file to understand how the <code>kfp-tekton</code> SDK has transformed your pipeline definition in Python into a runnable Tekton <code>PipelineRun</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: coin-toss-pipeline
  annotations:
    tekton.dev/output_artifacts
    ...
    tekton.dev/input_artifacts:
    ...</code></pre>
</div>
</div>
</li>
<li>
<p>The resulting yaml file <strong>coin-toss.yaml</strong> can then be uploaded through the RHOAI web console. Navigate to the <code>pipelines-example</code> DS project that you created in the previous section on Elyra piplines. Under the <code>Pipelines</code> section, click on <code>Import Pipeline</code>:</p>
<div class="imageblock unresolved">
<div class="content">
<img src="import-pipeline.png" alt="import pipeline">
</div>
<div class="title">Figure 1. Import Tekton YAML Resource File</div>
</div>
</li>
<li>
<p>Enter <strong>coin-toss-pipeline</strong> in the <code>Pipeline name</code> field, provide a brief description and upload the <code>coin-toss.yaml</code> file. Click <code>Import pipeline</code> to import the pipeline.</p>
</li>
</ol>
</div>
</div>
<div class="sect1">
<h2 id="_real_world_example"><a class="anchor" href="#_real_world_example"></a>Real World Example</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This entire section is to cover some theoretical concepts around creating Kubeflow pipelines using the KFP SDK. You are <strong>NOT</strong> expected to run this in your set up since the system has numerous complex components which are missing in your runtime environment. Do <strong>NOT</strong> execute any code or commands in this section. This section is for informational and pedagogical purposes only!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this section we&#8217;re going to demonstrate a real world Data Science Pipelines scenario.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>In this scenario we have a remote edge device which uses an AI model to manage the characteristics of its battery usage depending on the environment it&#8217;s deployed in. On a regular schedule it uploads battery events via a data gateway, and those battery events are used to train a model which is then retrieved by the device and used.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="openshift-ai-dsp-edge.png" alt="openshift ai dsp edge">
</div>
<div class="title">Figure 2. AI/ML at the edge example</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The entire pipeline definition is available <a href="#attachment$sample-pipeline-full.py" class="xref unresolved" target="_blank" rel="noopener">here</a> for inspection. We&#8217;re not going to go through all of it but focus on the key aspects of it.</p>
</div>
<div class="paragraph">
<p>The actual pipeline is defined by the following function:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">Unresolved include directive in modules/chapter4/pages/section3.adoc - include::example$sample-pipeline-full.py[]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <strong>@dsl.pipeline</strong> parameters provide the name and description if you were uploading the pipeline via an API call. The DSP UI can overwrite these values.</p>
</div>
<div class="paragraph">
<p>The function <strong><em>edgetest_pipeline</em></strong> function is the implementation of the pipeline.</p>
</div>
<div class="sect2">
<h3 id="_pipeline_parameters"><a class="anchor" href="#_pipeline_parameters"></a>Pipeline Parameters</h3>
<div class="paragraph">
<p>The pipeline has four parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>file_obj</em> and <em>src_bucket</em> refer to S3 bucket details and can be ignored.</p>
</li>
<li>
<p><em>VIN</em> is the edge device identifier and has a default value of 412356.</p>
</li>
<li>
<p><em>epoch_count</em> is the number of training epochs to be used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the <em>Create Run</em> UI these parameters are available so that users can override the values as they need.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="imageblock unresolved">
<div class="content">
<img src="pipeline-parameters.png" alt="pipeline parameters">
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pipeline_steps"><a class="anchor" href="#_pipeline_steps"></a>Pipeline Steps</h3>
<div class="paragraph">
<p>The file contains the following Python functions, which roughly correspond to the steps in the diagram above</p>
</div>
<div class="ulist">
<ul>
<li>
<p>load_trigger_data()</p>
</li>
<li>
<p>prep_data_train_model()</p>
</li>
<li>
<p>model_upload_notify()</p>
</li>
<li>
<p>model_inference()</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These functions are mapped into individual containers by using the <em>create_component_from_func</em> function. You can specify the container <em>base_image</em> to use as well as any additional Python packages to be installed into the container at execution time.</p>
</div>
<div class="paragraph">
<p>The Python functions can be used in multiple different step definitions; in the example the <em>prep_data_train_model</em> function is used in the <em>prep_data_train_op</em> and the <em>prep_inference_data_op</em> containers.</p>
</div>
<div class="paragraph">
<p>The pipeline execution <em>graph</em> is created using the following code:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The execution order of the graph is top down but also can be controlled by using the <strong><em>.after()</em></strong> operator.</p>
</div>
<div class="paragraph">
<p>There are other operators which control the flow of pipeline execution such as <em>Condition</em> , <em>ExitHandler</em>, <em>ParallelFor</em> .
These are not covered as part of this course but the <a href="https://github.com/kubeflow/pipelines/blob/master/samples/tutorials/DSL%20-%20Control%20structures/DSL%20-%20Control%20structures.py" target="_blank" rel="noopener">KFP documentation</a> has examples.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following diagram shows the order of execution.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="imageblock unresolved">
<div class="content">
<img src="pipeline-graph.png" alt="pipeline graph">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
